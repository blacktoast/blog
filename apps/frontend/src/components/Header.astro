---
import HeaderLink from './HeaderLink.astro';
import GlassNavIcon from './GlassNavIcon.tsx';
import LogoImgDm from '@/assets/text-logo-dm.webp';
import LogoImgLm from '@/assets/text-logo-lm.webp';
import LogoSpring from "@/assets/text-logo-spring.png";
import { Icon } from 'astro-icon/components';

interface Props {
	id?: string;
	isInspirationPage?: boolean;
}

const { id, isInspirationPage = false } = Astro.props;
const isPersonal = import.meta.env.PUBLIC_TYPE === 'personal';
const lightbulbClass = isInspirationPage ? 'lightbulb-lit' : '';

// 현재 URL 경로로 활성 상태 판단
const pathname = Astro.url.pathname;
const isBlogActive = pathname.startsWith('/blog');
const isPebblesActive = pathname.startsWith('/pebbles');
const isLogActive = pathname.startsWith('/log');
const isInspirationActive = pathname.startsWith('/inspiration');
---

<header id={id} class="m-0 px-4 bg-background/80 dark:bg-background/30 border-b border-border text-foreground mb-4">
	<nav class="mx-auto max-w-app px-0 sm:px-4 flex items-center justify-between gap-4 flex-wrap">
		<a href="/" class="no-underline text-inherit relative">
			<img src={LogoImgLm.src} alt="Blog" class="w-12 h-8 sm:w-21 sm:h-14 border-none m-0 p-0 dark:hidden spring:hidden" />
			<img src={LogoImgDm.src} alt="Blog" class="w-12 h-8 sm:w-21 sm:h-14 border-none m-0 p-0 hidden dark:block spring:hidden" />
			<img src={LogoSpring.src} alt="Blog" class="w-12 h-8 sm:w-21 sm:h-14 border-none m-0 p-0 hidden spring:block" />
		</a>

		<div class="flex items-center gap-1.5">
			<div class="flex items-center flex-wrap gap-2 max-[720px]:hidden">
				<GlassNavIcon href="/blog" label="Blog" isActive={isBlogActive}>
					<Icon name="lucide:book-text" class="w-5 h-5" />
				</GlassNavIcon>
				<GlassNavIcon href="/pebbles" label="Pebbles" isActive={isPebblesActive}>
					<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
						<g stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<path d="M14 21L16 14L20 15L22 19L20.5 21H14Z"/>
							<path d="M16 14L14 6L6 9L3 21H14"/>
						</g>
					</svg>
				</GlassNavIcon>
			{
				isPersonal ? <GlassNavIcon href="/log" label="Log" isActive={isLogActive}>
					<Icon name="lucide:scroll-text" class="w-5 h-5" />
				</GlassNavIcon> : null
			}
				<GlassNavIcon href="/inspiration" label="영감" isActive={isInspirationActive} className={lightbulbClass} data-lightbulb>
					<Icon name="lucide:lightbulb" class="w-5 h-5" />
				</GlassNavIcon>
			</div>
			<button
				id="theme-btn"
				type="button"
				class="relative grid place-items-center w-10 h-10 p-0 rounded-full bg-transparent text-inherit cursor-pointer transition-colors duration-200 hover:text-accent focus-visible:text-accent focus-visible:outline-none"
				title="Toggle color scheme"
				aria-label="auto"
				aria-live="polite"
			>
				<Icon name="lucide:sun" class="absolute w-6 h-6 transition-all duration-200 opacity-100 scale-100 dark:opacity-0 dark:scale-[0.6] spring:opacity-0 spring:scale-[0.6]" aria-hidden="true" />
				<Icon name="lucide:moon" class="absolute w-6 h-6 transition-all duration-200 opacity-0 scale-[0.6] dark:opacity-100 dark:scale-100 spring:opacity-0 spring:scale-[0.6]" aria-hidden="true" />
				<Icon name="lucide:flower-2" class="absolute w-6 h-6 transition-all duration-200 opacity-0 scale-[0.6] spring:opacity-100 spring:scale-100" aria-hidden="true" />
				<span class="sr-only">Toggle color scheme</span>
			</button>

			<details id="mobile-menu" class="relative hidden max-[720px]:block">
				<summary class="list-none marker:hidden grid place-items-center w-10 h-10 rounded-full bg-transparent text-inherit cursor-pointer transition-all duration-200 hover:text-accent focus-visible:text-accent focus-visible:outline-none">
					<Icon name="lucide:menu" class="w-6 h-6 transition-opacity duration-200" />
					<span class="sr-only">메뉴 열기</span>
				</summary>
				<div id="mobile-menu-content" class="absolute right-0 mt-2 w-32 rounded-xl border border-border bg-background/95 dark:bg-background/90 backdrop-blur shadow-lg p-2 flex flex-col gap-1 z-50 opacity-0">
					<GlassNavIcon href="/blog" label="Blog" isActive={isBlogActive} variant="mobile" showLabel>
						<Icon name="lucide:book-text" class="w-5 h-5" />
					</GlassNavIcon>
					<GlassNavIcon href="/pebbles" label="Pebbles" isActive={isPebblesActive} variant="mobile" showLabel>
						<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
							<g stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<path d="M14 21L16 14L20 15L22 19L20.5 21H14Z"/>
								<path d="M16 14L14 6L6 9L3 21H14"/>
							</g>
						</svg>
					</GlassNavIcon>
					{
						isPersonal ? <GlassNavIcon href="/log" label="Log" isActive={isLogActive} variant="mobile" showLabel>
							<Icon name="lucide:scroll-text" class="w-5 h-5" />
						</GlassNavIcon> : null
					}
					<GlassNavIcon href="/inspiration" label="영감" isActive={isInspirationActive} variant="mobile" showLabel className={lightbulbClass} data-lightbulb-mobile>
						<Icon name="lucide:lightbulb" class="w-5 h-5" />
					</GlassNavIcon>
				</div>
			</details>
		</div>
	</nav>
</header>

<style>
	#mobile-menu[open] > summary {
		opacity: 0.5;
	}

	/* 전구 "불 켜진" 효과 - inspiration 페이지에서만 적용 */
	.lightbulb-lit {
		color: var(--color-accent);
		filter: drop-shadow(0 0 8px var(--color-accent))
		        drop-shadow(0 0 16px var(--color-accent));
		animation: bulb-glow 2s ease-in-out infinite alternate;
	}

	@keyframes bulb-glow {
		0% {
			filter: drop-shadow(0 0 6px var(--color-accent))
			        drop-shadow(0 0 12px var(--color-accent));
		}
		100% {
			filter: drop-shadow(0 0 10px var(--color-accent))
			        drop-shadow(0 0 20px var(--color-accent))
			        drop-shadow(0 0 30px var(--color-accent));
		}
	}
</style>

<script>
import { animate } from "motion";

let cleanupFunctions: Array<() => void> = [];

const init = () => {
	// 이전 리스너 정리
	cleanupFunctions.forEach(cleanup => cleanup());
	cleanupFunctions = [];

	const mobileMenu = document.getElementById('mobile-menu');
	const mobileMenuContent = document.getElementById('mobile-menu-content');
	if (!mobileMenu || !mobileMenuContent) return;

	let currentAnimation: ReturnType<typeof animate> | null = null;
	let isClosing = false;

	const openMenu = () => {
		// 이전 애니메이션 취소
		if (currentAnimation) {
			currentAnimation.stop();
		}

		mobileMenuContent.style.opacity = '0';
		mobileMenuContent.style.transform = 'translateY(-8px) scale(0.95)';

		requestAnimationFrame(() => {
			currentAnimation = animate(mobileMenuContent, {
				opacity: 1,
				transform: 'translateY(0) scale(1)',
			}, {
				duration: 0.2,
				ease: [0.22, 1, 0.36, 1],
			});
		});
	};

	const closeMenu = () => {
		if (isClosing) return;
		isClosing = true;

		// 이전 애니메이션 취소
		if (currentAnimation) {
			currentAnimation.stop();
		}

		// 닫기 애니메이션 실행
		currentAnimation = animate(mobileMenuContent, {
			opacity: 0,
			transform: 'translate3d(40px, -80px, 0) scale(0.1)',
		}, {
			duration: 0.3,
			ease: [0.22, 1, 0.36, 1],
		});

		// 애니메이션 완료 후 open 속성 제거
		currentAnimation.finished.then(() => {
			mobileMenu.removeAttribute('open');
			isClosing = false;
		});
	};

	// toggle 이벤트로 열림/닫힘 감지
	const handleToggle = () => {
		if (mobileMenu.hasAttribute('open')) {
			openMenu();
		} else if (!isClosing) {
			// 닫힐 때 (isClosing이 false일 때만 - 외부에서 직접 닫힌 경우)
			closeMenu();
		}
	};
	mobileMenu.addEventListener('toggle', handleToggle);
	cleanupFunctions.push(() => {
		mobileMenu.removeEventListener('toggle', handleToggle);
	});

	// summary 클릭 시 기본 동작 처리
	const summary = mobileMenu.querySelector('summary');
	if (summary) {
		const handleSummaryClick = (event: MouseEvent) => {
			// 이미 열려있으면 닫기 애니메이션 실행
			if (mobileMenu.hasAttribute('open')) {
				event.preventDefault();
				closeMenu();
			}
		};
		summary.addEventListener('click', handleSummaryClick);
		cleanupFunctions.push(() => {
			summary.removeEventListener('click', handleSummaryClick);
		});
	}

	// 외부 클릭 시 메뉴 닫기
	const handleDocumentClick = (event: MouseEvent) => {
		console.log('click in header');
		if (!event.target) return;
		const target = event.target as Node;
		const isClickInside = mobileMenu.contains(target);
		if (!isClickInside && mobileMenu.hasAttribute('open')) {
			closeMenu();
		}
	};
	document.addEventListener('click', handleDocumentClick);
	cleanupFunctions.push(() => {
		document.removeEventListener('click', handleDocumentClick);
	});

	// 전구 클릭 이벤트 (inspiration 페이지에서만 동작)
	const setupLightbulbClick = () => {
		const lightbulbDesktop = document.querySelector('[data-lightbulb]');
		const lightbulbMobile = document.querySelector('[data-lightbulb-mobile]');

		const handleLightbulbClick = (event: Event) => {
			// inspiration 페이지인지 확인
			if (!window.location.pathname.includes('inspiration')) return;

			event.preventDefault();
			const target = event.currentTarget as HTMLElement;
			const rect = target.getBoundingClientRect();

			// 전구 아이콘 중심 좌표 계산
			const x = rect.left + rect.width / 2;
			const y = rect.top + rect.height / 2;

			// 커스텀 이벤트 발생
			window.dispatchEvent(new CustomEvent('lightbulb-click', {
				detail: { x, y }
			}));
		};

		if (lightbulbDesktop) {
			lightbulbDesktop.addEventListener('click', handleLightbulbClick);
			cleanupFunctions.push(() => {
				lightbulbDesktop.removeEventListener('click', handleLightbulbClick);
			});
		}

		if (lightbulbMobile) {
			lightbulbMobile.addEventListener('click', handleLightbulbClick);
			cleanupFunctions.push(() => {
				lightbulbMobile.removeEventListener('click', handleLightbulbClick);
			});
		}
	};

	setupLightbulbClick();
};

// 페이지 로드 시 초기화
document.addEventListener('astro:page-load', init);

// 페이지 전환 전 정리
document.addEventListener('astro:before-swap', () => {
	cleanupFunctions.forEach(cleanup => cleanup());
	cleanupFunctions = [];
});
</script>



