---
import HeaderLink from './HeaderLink.astro';
import LogoImgDm from '@/assets/text-logo-dm.webp';
import LogoImgLm from '@/assets/text-logo-lm.webp';
import { Icon } from 'astro-icon/components';

interface Props {
	id?: string;
}

const { id } = Astro.props;
---

<header id={id} class="m-0 px-4 bg-background/80 dark:bg-background/30 border-b border-border text-foreground mb-4">
	<nav class="mx-auto max-w-app px-0 sm:px-4 flex items-center justify-between gap-4 flex-wrap">
		<a href="/" class="no-underline text-inherit relative">
			<img src={LogoImgLm.src} alt="Blog" class="w-12 h-8 sm:w-20 sm:h-14 border-none m-0 p-0 dark:hidden" />
			<img src={LogoImgDm.src} alt="Blog" class="w-12 h-8 sm:w-20 sm:h-14 border-none m-0 p-0 hidden dark:block" />
		</a>



		<div class="flex items-center gap-1.5">
			<div class="flex items-center flex-wrap gap-2 max-[720px]:hidden">
				<HeaderLink href="/" class="py-4 px-2 text-inherit border-b-4 border-transparent no-underline transition-colors duration-200 hover:text-accent focus-visible:text-accent  [&.active]:text-accent [&.active]:border-b-accent">Home</HeaderLink>
				<HeaderLink href="/blog" class="py-4 px-2 text-inherit border-b-4 border-transparent no-underline transition-colors duration-200 hover:text-accent focus-visible:text-accent [&.active]:text-accent [&.active]:border-b-accent">Blog</HeaderLink>
				<HeaderLink href="/pebbles" class="py-4 px-2 text-inherit border-b-4 border-transparent no-underline transition-colors duration-200 hover:text-accent focus-visible:text-accent [&.active]:text-accent [&.active]:border-b-accent">ðŸª¨</HeaderLink>
				<a href="/log" class="p-2 text-inherit no-underline transition-colors duration-200 hover:text-accent focus-visible:text-accent" aria-label="Log">
					<Icon name="lucide:scroll-text" class="w-6 h-6" />
				</a>
			</div>
			<button
				id="theme-btn"
				type="button"
				class="relative grid place-items-center w-10 h-10 p-0 rounded-full bg-transparent text-inherit cursor-pointer transition-colors duration-200 hover:text-accent focus-visible:text-accent focus-visible:outline-none"
				title="Toggle color scheme"
				aria-label="auto"
				aria-live="polite"
			>
				<Icon name="lucide:sun" class="absolute w-6 h-6 transition-all duration-200 opacity-100 scale-100 dark:opacity-0 dark:scale-[0.6]" aria-hidden="true" />
				<Icon name="lucide:moon" class="absolute w-6 h-6 transition-all duration-200 opacity-0 scale-[0.6] dark:opacity-100 dark:scale-100" aria-hidden="true" />
				<span class="sr-only">Toggle color scheme</span>
			</button>

			<details id="mobile-menu" class="relative hidden max-[720px]:block">
				<summary class="list-none marker:hidden grid place-items-center w-10 h-10 rounded-full bg-transparent text-inherit cursor-pointer transition-all duration-200 hover:text-accent focus-visible:text-accent focus-visible:outline-none">
					<Icon name="lucide:menu" class="w-6 h-6 transition-opacity duration-200" />
					<span class="sr-only">ë©”ë‰´ ì—´ê¸°</span>
				</summary>
				<div id="mobile-menu-content" class="absolute right-0 mt-2 w-28 rounded-xl border border-border bg-background/95 dark:bg-background/90 backdrop-blur shadow-lg p-2 flex flex-col gap-1 z-50 opacity-0">
					<HeaderLink href="/" class="py-2 px-3 rounded-lg text-inherit no-underline transition-colors duration-200 hover:text-accent focus-visible:text-accent">Home</HeaderLink>
					<HeaderLink href="/blog" class="py-2 px-3 rounded-lg text-inherit no-underline transition-colors duration-200 hover:text-accent focus-visible:text-accent">Blog</HeaderLink>
					<HeaderLink href="/pebbles" class="py-2 px-3 rounded-lg text-inherit no-underline transition-colors duration-200 hover:text-accent focus-visible:text-accent">ðŸª¨</HeaderLink>
					<a href="/log" class="py-2 px-3 rounded-lg text-inherit no-underline transition-colors duration-200 hover:text-accent focus-visible:text-accent">				
						<Icon name="lucide:scroll-text" class="w-6 h-6" />
					</a>
				</div>
			</details>
		</div>
	</nav>
</header>

<style>
	#mobile-menu[open] > summary {
		opacity: 0.5;
	}
</style>

<script>
import { animate } from "motion";

let cleanupFunctions: Array<() => void> = [];

const init = () => {
	// ì´ì „ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
	cleanupFunctions.forEach(cleanup => cleanup());
	cleanupFunctions = [];

	const mobileMenu = document.getElementById('mobile-menu');
	const mobileMenuContent = document.getElementById('mobile-menu-content');
	if (!mobileMenu || !mobileMenuContent) return;

	let currentAnimation: ReturnType<typeof animate> | null = null;
	let isClosing = false;

	const openMenu = () => {
		// ì´ì „ ì• ë‹ˆë©”ì´ì…˜ ì·¨ì†Œ
		if (currentAnimation) {
			currentAnimation.stop();
		}

		mobileMenuContent.style.opacity = '0';
		mobileMenuContent.style.transform = 'translateY(-8px) scale(0.95)';

		requestAnimationFrame(() => {
			currentAnimation = animate(mobileMenuContent, {
				opacity: 1,
				transform: 'translateY(0) scale(1)',
			}, {
				duration: 0.2,
				ease: [0.22, 1, 0.36, 1],
			});
		});
	};

	const closeMenu = () => {
		if (isClosing) return;
		isClosing = true;

		// ì´ì „ ì• ë‹ˆë©”ì´ì…˜ ì·¨ì†Œ
		if (currentAnimation) {
			currentAnimation.stop();
		}

		// ë‹«ê¸° ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
		currentAnimation = animate(mobileMenuContent, {
			opacity: 0,
			transform: 'translate3d(40px, -80px, 0) scale(0.1)',
		}, {
			duration: 0.3,
			ease: [0.22, 1, 0.36, 1],
		});
		
		// ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ open ì†ì„± ì œê±°
		currentAnimation.finished.then(() => {
			mobileMenu.removeAttribute('open');
			isClosing = false;
		});
	};

	// toggle ì´ë²¤íŠ¸ë¡œ ì—´ë¦¼/ë‹«íž˜ ê°ì§€
	const handleToggle = () => {
		if (mobileMenu.hasAttribute('open')) {
			openMenu();
		} else if (!isClosing) {
			// ë‹«íž ë•Œ (isClosingì´ falseì¼ ë•Œë§Œ - ì™¸ë¶€ì—ì„œ ì§ì ‘ ë‹«ížŒ ê²½ìš°)
			closeMenu();
		}
	};
	mobileMenu.addEventListener('toggle', handleToggle);
	cleanupFunctions.push(() => {
		mobileMenu.removeEventListener('toggle', handleToggle);
	});

	// summary í´ë¦­ ì‹œ ê¸°ë³¸ ë™ìž‘ ì²˜ë¦¬
	const summary = mobileMenu.querySelector('summary');
	if (summary) {
		const handleSummaryClick = (event: MouseEvent) => {
			// ì´ë¯¸ ì—´ë ¤ìžˆìœ¼ë©´ ë‹«ê¸° ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
			if (mobileMenu.hasAttribute('open')) {
				event.preventDefault();
				closeMenu();
			}
		};
		summary.addEventListener('click', handleSummaryClick);
		cleanupFunctions.push(() => {
			summary.removeEventListener('click', handleSummaryClick);
		});
	}

	// ì™¸ë¶€ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸°
	const handleDocumentClick = (event: MouseEvent) => {
		console.log('click in header');
		if (!event.target) return;
		const target = event.target as Node;
		const isClickInside = mobileMenu.contains(target);
		if (!isClickInside && mobileMenu.hasAttribute('open')) {
			closeMenu();
		}
	};
	document.addEventListener('click', handleDocumentClick);
	cleanupFunctions.push(() => {
		document.removeEventListener('click', handleDocumentClick);
	});
};

// íŽ˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('astro:page-load', init);

// íŽ˜ì´ì§€ ì „í™˜ ì „ ì •ë¦¬
document.addEventListener('astro:before-swap', () => {
	cleanupFunctions.forEach(cleanup => cleanup());
	cleanupFunctions = [];
});
</script>


