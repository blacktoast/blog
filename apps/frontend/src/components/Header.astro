---
import HeaderLink from './HeaderLink.astro';
import LogoImgDm from '@/assets/text-logo-dm.webp';
import LogoImgLm from '@/assets/text-logo-lm.webp';
import LogoSpring from "@/assets/text-logo-spring.png";
import { Icon } from 'astro-icon/components';

interface Props {
	id?: string;
	isInspirationPage?: boolean;
}

const { id, isInspirationPage = false } = Astro.props;
const isPersonal = import.meta.env.PUBLIC_TYPE === 'personal';
const lightbulbClass = isInspirationPage ? 'lightbulb-lit' : '';
---

<header id={id} class="m-0 px-4 bg-background/80 dark:bg-background/30 border-b border-border text-foreground mb-4">
	<nav class="mx-auto max-w-app px-0 sm:px-4 flex items-center justify-between gap-4 flex-wrap">
		<a href="/" class="no-underline text-inherit relative">
			<img src={LogoImgLm.src} alt="Blog" class="w-12 h-8 sm:w-21 sm:h-14 border-none m-0 p-0 dark:hidden spring:hidden" />
			<img src={LogoImgDm.src} alt="Blog" class="w-12 h-8 sm:w-21 sm:h-14 border-none m-0 p-0 hidden dark:block spring:hidden" />
			<img src={LogoSpring.src} alt="Blog" class="w-12 h-8 sm:w-21 sm:h-14 border-none m-0 p-0 hidden spring:block" />
		</a>

		<div class="flex items-center gap-1.5">
			<div class="flex items-center flex-wrap gap-2 max-[720px]:hidden">
				<HeaderLink href="/blog" class="py-4 px-2 text-inherit border-b-4 border-transparent no-underline transition-colors duration-200 hover:text-accent focus-visible:text-accent [&.active]:text-accent [&.active]:border-b-accent">Blog</HeaderLink>
				<HeaderLink href="/pebbles" class="py-4 px-2 text-inherit border-b-4 border-transparent no-underline transition-colors duration-200 hover:text-accent focus-visible:text-accent [&.active]:text-accent [&.active]:border-b-accent">
					<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
						<g stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<path d="M14 21L16 14L20 15L22 19L20.5 21H14Z"/>
							<path d="M16 14L14 6L6 9L3 21H14"/>
						</g>
					</svg>
				</HeaderLink>
			{
				isPersonal ? <a href="/log" class="p-2 text-inherit no-underline transition-colors duration-200 hover:text-accent focus-visible:text-accent" aria-label="Log">
					<Icon name="lucide:scroll-text" class="w-6 h-6" />
				</a> : null
			}
				<a href="/inspiration" class:list={["p-2 text-inherit no-underline transition-colors duration-200 hover:text-accent focus-visible:text-accent", lightbulbClass]} aria-label="ÏòÅÍ∞ê" data-lightbulb>
					<Icon name="lucide:lightbulb" class="w-6 h-6" />
				</a>
			</div>
			<button
				id="theme-btn"
				type="button"
				class="relative grid place-items-center w-10 h-10 p-0 rounded-full bg-transparent text-inherit cursor-pointer transition-colors duration-200 hover:text-accent focus-visible:text-accent focus-visible:outline-none"
				title="Toggle color scheme"
				aria-label="auto"
				aria-live="polite"
			>
				<Icon name="lucide:sun" class="absolute w-6 h-6 transition-all duration-200 opacity-100 scale-100 dark:opacity-0 dark:scale-[0.6] spring:opacity-0 spring:scale-[0.6]" aria-hidden="true" />
				<Icon name="lucide:moon" class="absolute w-6 h-6 transition-all duration-200 opacity-0 scale-[0.6] dark:opacity-100 dark:scale-100 spring:opacity-0 spring:scale-[0.6]" aria-hidden="true" />
				<Icon name="lucide:flower-2" class="absolute w-6 h-6 transition-all duration-200 opacity-0 scale-[0.6] spring:opacity-100 spring:scale-100" aria-hidden="true" />
				<span class="sr-only">Toggle color scheme</span>
			</button>

			<details id="mobile-menu" class="relative hidden max-[720px]:block">
				<summary class="list-none marker:hidden grid place-items-center w-10 h-10 rounded-full bg-transparent text-inherit cursor-pointer transition-all duration-200 hover:text-accent focus-visible:text-accent focus-visible:outline-none">
					<Icon name="lucide:menu" class="w-6 h-6 transition-opacity duration-200" />
					<span class="sr-only">Î©îÎâ¥ Ïó¥Í∏∞</span>
				</summary>
				<div id="mobile-menu-content" class="absolute right-0 mt-2 w-28 rounded-xl border border-border bg-background/95 dark:bg-background/90 backdrop-blur shadow-lg p-2 flex flex-col gap-1 z-50 opacity-0">
					<HeaderLink href="/blog" class="py-2 px-3 rounded-lg text-inherit no-underline transition-colors duration-200 hover:text-accent focus-visible:text-accent">Blog</HeaderLink>
					<HeaderLink href="/pebbles" class="py-2 px-3 rounded-lg text-inherit no-underline transition-colors duration-200 hover:text-accent focus-visible:text-accent">ü™®</HeaderLink>
					{
						isPersonal ? <a href="/log" class="py-2 px-3 rounded-lg text-inherit no-underline transition-colors duration-200 hover:text-accent focus-visible:text-accent">
						<Icon name="lucide:scroll-text" class="w-6 h-6" />
					</a> : null
					}
					<a href="/inspiration" class:list={["py-2 px-3 rounded-lg text-inherit no-underline transition-colors duration-200 hover:text-accent focus-visible:text-accent", lightbulbClass]} aria-label="ÏòÅÍ∞ê" data-lightbulb-mobile>
						<Icon name="lucide:lightbulb" class="w-6 h-6" />
					</a>
				</div>
			</details>
		</div>
	</nav>
</header>

<style>
	#mobile-menu[open] > summary {
		opacity: 0.5;
	}

	/* Ï†ÑÍµ¨ "Î∂à ÏºúÏßÑ" Ìö®Í≥º - inspiration ÌéòÏù¥ÏßÄÏóêÏÑúÎßå Ï†ÅÏö© */
	.lightbulb-lit {
		color: var(--color-accent);
		filter: drop-shadow(0 0 8px var(--color-accent))
		        drop-shadow(0 0 16px var(--color-accent));
		animation: bulb-glow 2s ease-in-out infinite alternate;
	}

	@keyframes bulb-glow {
		0% {
			filter: drop-shadow(0 0 6px var(--color-accent))
			        drop-shadow(0 0 12px var(--color-accent));
		}
		100% {
			filter: drop-shadow(0 0 10px var(--color-accent))
			        drop-shadow(0 0 20px var(--color-accent))
			        drop-shadow(0 0 30px var(--color-accent));
		}
	}
</style>

<script>
import { animate } from "motion";

let cleanupFunctions: Array<() => void> = [];

const init = () => {
	// Ïù¥Ï†Ñ Î¶¨Ïä§ÎÑà Ï†ïÎ¶¨
	cleanupFunctions.forEach(cleanup => cleanup());
	cleanupFunctions = [];

	const mobileMenu = document.getElementById('mobile-menu');
	const mobileMenuContent = document.getElementById('mobile-menu-content');
	if (!mobileMenu || !mobileMenuContent) return;

	let currentAnimation: ReturnType<typeof animate> | null = null;
	let isClosing = false;

	const openMenu = () => {
		// Ïù¥Ï†Ñ Ïï†ÎãàÎ©îÏù¥ÏÖò Ï∑®ÏÜå
		if (currentAnimation) {
			currentAnimation.stop();
		}

		mobileMenuContent.style.opacity = '0';
		mobileMenuContent.style.transform = 'translateY(-8px) scale(0.95)';

		requestAnimationFrame(() => {
			currentAnimation = animate(mobileMenuContent, {
				opacity: 1,
				transform: 'translateY(0) scale(1)',
			}, {
				duration: 0.2,
				ease: [0.22, 1, 0.36, 1],
			});
		});
	};

	const closeMenu = () => {
		if (isClosing) return;
		isClosing = true;

		// Ïù¥Ï†Ñ Ïï†ÎãàÎ©îÏù¥ÏÖò Ï∑®ÏÜå
		if (currentAnimation) {
			currentAnimation.stop();
		}

		// Îã´Í∏∞ Ïï†ÎãàÎ©îÏù¥ÏÖò Ïã§Ìñâ
		currentAnimation = animate(mobileMenuContent, {
			opacity: 0,
			transform: 'translate3d(40px, -80px, 0) scale(0.1)',
		}, {
			duration: 0.3,
			ease: [0.22, 1, 0.36, 1],
		});

		// Ïï†ÎãàÎ©îÏù¥ÏÖò ÏôÑÎ£å ÌõÑ open ÏÜçÏÑ± Ï†úÍ±∞
		currentAnimation.finished.then(() => {
			mobileMenu.removeAttribute('open');
			isClosing = false;
		});
	};

	// toggle Ïù¥Î≤§Ìä∏Î°ú Ïó¥Î¶º/Îã´Ìûò Í∞êÏßÄ
	const handleToggle = () => {
		if (mobileMenu.hasAttribute('open')) {
			openMenu();
		} else if (!isClosing) {
			// Îã´Ìûê Îïå (isClosingÏù¥ falseÏùº ÎïåÎßå - Ïô∏Î∂ÄÏóêÏÑú ÏßÅÏ†ë Îã´Ìûå Í≤ΩÏö∞)
			closeMenu();
		}
	};
	mobileMenu.addEventListener('toggle', handleToggle);
	cleanupFunctions.push(() => {
		mobileMenu.removeEventListener('toggle', handleToggle);
	});

	// summary ÌÅ¥Î¶≠ Ïãú Í∏∞Î≥∏ ÎèôÏûë Ï≤òÎ¶¨
	const summary = mobileMenu.querySelector('summary');
	if (summary) {
		const handleSummaryClick = (event: MouseEvent) => {
			// Ïù¥ÎØ∏ Ïó¥Î†§ÏûàÏúºÎ©¥ Îã´Í∏∞ Ïï†ÎãàÎ©îÏù¥ÏÖò Ïã§Ìñâ
			if (mobileMenu.hasAttribute('open')) {
				event.preventDefault();
				closeMenu();
			}
		};
		summary.addEventListener('click', handleSummaryClick);
		cleanupFunctions.push(() => {
			summary.removeEventListener('click', handleSummaryClick);
		});
	}

	// Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Î©îÎâ¥ Îã´Í∏∞
	const handleDocumentClick = (event: MouseEvent) => {
		console.log('click in header');
		if (!event.target) return;
		const target = event.target as Node;
		const isClickInside = mobileMenu.contains(target);
		if (!isClickInside && mobileMenu.hasAttribute('open')) {
			closeMenu();
		}
	};
	document.addEventListener('click', handleDocumentClick);
	cleanupFunctions.push(() => {
		document.removeEventListener('click', handleDocumentClick);
	});

	// Ï†ÑÍµ¨ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (inspiration ÌéòÏù¥ÏßÄÏóêÏÑúÎßå ÎèôÏûë)
	const setupLightbulbClick = () => {
		const lightbulbDesktop = document.querySelector('[data-lightbulb]');
		const lightbulbMobile = document.querySelector('[data-lightbulb-mobile]');

		const handleLightbulbClick = (event: Event) => {
			// inspiration ÌéòÏù¥ÏßÄÏù∏ÏßÄ ÌôïÏù∏
			if (!window.location.pathname.includes('inspiration')) return;

			event.preventDefault();
			const target = event.currentTarget as HTMLElement;
			const rect = target.getBoundingClientRect();

			// Ï†ÑÍµ¨ ÏïÑÏù¥ÏΩò Ï§ëÏã¨ Ï¢åÌëú Í≥ÑÏÇ∞
			const x = rect.left + rect.width / 2;
			const y = rect.top + rect.height / 2;

			// Ïª§Ïä§ÌÖÄ Ïù¥Î≤§Ìä∏ Î∞úÏÉù
			window.dispatchEvent(new CustomEvent('lightbulb-click', {
				detail: { x, y }
			}));
		};

		if (lightbulbDesktop) {
			lightbulbDesktop.addEventListener('click', handleLightbulbClick);
			cleanupFunctions.push(() => {
				lightbulbDesktop.removeEventListener('click', handleLightbulbClick);
			});
		}

		if (lightbulbMobile) {
			lightbulbMobile.addEventListener('click', handleLightbulbClick);
			cleanupFunctions.push(() => {
				lightbulbMobile.removeEventListener('click', handleLightbulbClick);
			});
		}
	};

	setupLightbulbClick();
};

// ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
document.addEventListener('astro:page-load', init);

// ÌéòÏù¥ÏßÄ Ï†ÑÌôò Ï†Ñ Ï†ïÎ¶¨
document.addEventListener('astro:before-swap', () => {
	cleanupFunctions.forEach(cleanup => cleanup());
	cleanupFunctions = [];
});
</script>



