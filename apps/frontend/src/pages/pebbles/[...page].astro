---
import Header from '@/components/Header.astro';
import Layout from '@/layouts/Layout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import { Icon } from 'astro-icon/components';
import { PERSONAL_TAGS } from '@/constants';

export async function getStaticPaths({ paginate }: any) {
	const isPersonal = import.meta.env.PUBLIC_TYPE === 'personal';
	
	const allPebbles = (await getCollection('pebbles'))
	.filter((post) => isPersonal ? true : !post.data.tags.some((tag)=> {
		return PERSONAL_TAGS.includes(tag)
	}))
	.sort(
		(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
	);

	return paginate(allPebbles, { pageSize: 10 });
}

interface PageProps {
	page: {
		data: CollectionEntry<'pebbles'>[];
		currentPage: number;
		lastPage: number;
		url: {
			current: string;
			prev?: string;
			next?: string;
		};
	};
}

const { page } = Astro.props as PageProps;
const posts = page.data;
const pageTitle = 'Pebbles';
const pageDescription = '작은 기록과 초안들을 모아둔 공간';
---

<Layout title={pageTitle} description={pageDescription}>
	<Header />
	<main 
		class="flex flex-col gap-4 sm:gap-8 w-full max-w-[780px] mx-auto px-6 pt-4 sm:pt-8 pb-4 sm:pb-20 text-inherit" 
		aria-labelledby="pebbles-heading"
	>
		<p class="breadcrumb mb-2">
			<a href="/">Home</a>
			<span aria-hidden="true">»</span>
			<span>Pebbles</span>
			{page.currentPage > 1 && (
				<>
					<span aria-hidden="true">»</span>
					<span class="page-indicator">(Page {page.currentPage})</span>
				</>
			)}
			{page.currentPage === 1 && (
				<span class="page-indicator">(Page 1)</span>
			)}
		</p>
		<section aria-label="Pebble posts" class="p-0 w-full">
			<ul class="list-none m-0 p-0 flex flex-col gap-8">
				{
					posts.map((post) => {
						const tags = post.data.tags ?? [];

						return (
							<li class="flex flex-col gap-2 pb-8 border-b border-border/50 last:border-0">
								<a 
									class="text-xl font-semibold text-foreground no-underline hover:text-accent transition-colors duration-200" 
									href={`/pebbles/${post.id}/`}
								>
									{post.data.title}
								</a>
								{tags.length > 0 && (
									<div class="flex items-center gap-2 flex-wrap text-sm text-muted">
										{
											tags.map((tag) => (
												<span class="flex items-center gap-1 bg-muted/10 px-2 py-0.5 rounded text-xs font-medium text-muted-foreground">
													<Icon name="lucide:hash" class="w-3 h-3" />
													{tag}
												</span>
											))
										}
									</div>
								)}
							</li>
						);
					})
				}
			</ul>
		</section>

		{page.lastPage > 1 && (
			<nav aria-label="Pagination" class="flex items-center justify-center gap-2 pt-8">
				{page.url.prev && (
					<a 
						href={page.url.prev} 
						class="px-4 py-2 rounded-lg border border-border bg-transparent text-foreground no-underline hover:border-accent hover:text-accent transition-colors duration-200"
					>
						← 이전
					</a>
				)}
				<span class="px-4 py-2 text-muted">
					페이지 {page.currentPage} / {page.lastPage}
				</span>
				{page.url.next && (
					<a 
						href={page.url.next} 
						class="px-4 py-2 rounded-lg border border-border bg-transparent text-foreground no-underline hover:border-accent hover:text-accent transition-colors duration-200"
					>
						다음 →
					</a>
				)}
			</nav>
		)}
	</main>
</Layout>
