---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import LogEntry from '../../components/LogEntry.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../../constants';
import { getCollection } from 'astro:content';
import Layout from '@/layouts/Layout.astro';
import BlurTop from '@/components/BlurTop.astro';




const isPersonal = import.meta.env.PUBLIC_TYPE === 'personal';
const logs = (await getCollection('log')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// 최근 30개의 로그만 표시
const recentLogs = isPersonal ? logs.slice(0, 30) : [];

const years = [...new Set(logs.map((log) => log.data.pubDate.getFullYear()))].sort((a, b) => b - a);

const formatMonthLabel = (date: Date) => `${date.getMonth() + 1}월`;
const formatYearLabel = (date: Date) => `${date.getFullYear()}년`;
---

<Layout title={`일지 - 최근 30개`} description={SITE_DESCRIPTION}>
	<Header id="blog-header" />
	{isPersonal ? (
	<BlurTop />
		<main class="w-full max-w-app mx-auto px-4">
			<section class="mb-12">
				<!-- <h1 class="text-3xl font-bold mb-6">최근 30개 일지</h1> -->
				<div class="space-y-2">
					{
						recentLogs.map((log, idx) => {
							const prev = idx > 0 ? recentLogs[idx - 1] : null;
							const monthChanged =
								!prev ||
								prev.data.pubDate.getFullYear() !== log.data.pubDate.getFullYear() ||
								prev.data.pubDate.getMonth() !== log.data.pubDate.getMonth();
							return (
								<>
									{monthChanged && (
										<div class="flex items-baseline gap-2 pt-6 pb-2 text-muted-foreground">
											<div class="text-3xl font-semibold">{formatMonthLabel(log.data.pubDate)}</div>
											<span class="text-lg">{formatYearLabel(log.data.pubDate)}</span>
										</div>
									)}
									<LogEntry log={log} />
								</>
							);
						})
					}
				</div>
			</section>

			<section class="border-t border-border pt-8">
				<h2 class="text-2xl font-bold mb-4">Archive</h2>
				<div class="flex gap-4 flex-wrap">
					{
						years.map((year) => (
							<a href={`/log/${year}`} class="px-4 py-2 bg-secondary rounded-lg hover:bg-accent hover:text-accent-foreground transition-colors">
								{year}
							</a>
						))
					}
				</div>
			</section>
		</main>
		) : null}
		<Footer />
</Layout>

