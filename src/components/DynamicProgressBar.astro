---
import { Icon } from 'astro-icon/components';
import type { MarkdownHeading } from 'astro';

interface Props {
  title: string;
  headings: MarkdownHeading[];
}

const { title, headings } = Astro.props;
---

<div id="dynamic-island-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 transition-all duration-300 opacity-0 translate-y-[-20px] pointer-events-none">
  <div id="dynamic-island" class="relative group cursor-pointer">
    
    <div class="dynamic-island-content relative flex flex-col items-center px-4 py-2 bg-background/60 backdrop-blur-md border border-white/10 rounded-xl shadow-lg">
      <div class="dynamic-island-header flex items-center gap-3">
       <div class="relative w-5 h-5 flex items-center justify-center">
          <svg class="w-full h-full -rotate-90" viewBox="0 0 36 36">
          <path
            class="text-muted/20"
            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
            fill="none"
            stroke="currentColor"
            stroke-width="4"
          />
          <path
            id="progress-circle"
            class="text-accent transition-all duration-100 ease-out"
            stroke-dasharray="0, 100"
            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
            fill="none"
            stroke="currentColor"
            stroke-width="4"
          />
        </svg>
      </div>
      <span class="text-sm font-medium truncate max-w-[200px] sm:max-w-[300px]">{title}</span>
      <Icon name="lucide:chevron-down" class="w-4 h-4 text-muted-foreground transition-transform duration-300 group-[.open]:rotate-180" />
       </div>

    <!-- Table of Contents Dropdown -->
    <div
      id="toc-dropdown"
      class="w-full max-h-0 opacity-0 scale-y-95 pointer-events-none overflow-hidden origin-top transition-[max-height,opacity,transform] duration-[400ms] ease-[cubic-bezier(0.22,1,0.36,1)]"
      aria-hidden="true"
    >
      <nav class="flex flex-col gap-1">
        {headings.filter(h => h.depth <= 3).map((heading) => (
          <a 
            href={`#${heading.slug}`} 
            class:list={[
              "text-sm px-3 py-1.5 rounded-lg hover:bg-accent/10 transition-colors text-muted-foreground hover:text-foreground truncate block",
              { "pl-3": heading.depth === 1, "pl-6": heading.depth === 2, "pl-9": heading.depth === 3 }
            ]}
          >
            {heading.text}
          </a>
        ))}
      </nav>
    </div>
    </div>


  </div>
</div>

<script is:inline data-astro-rerun>
  const island = document.getElementById('dynamic-island');
  const progressCircle = document.getElementById('progress-circle');
  const tocDropdown = document.getElementById('toc-dropdown');
  const dynamicContent = document.querySelector('.dynamic-island-content');
  const headerRow = document.querySelector('.dynamic-island-header');

  let isTocOpen = false;

  if (tocDropdown) {
    tocDropdown.style.maxHeight = '0px';
    tocDropdown.style.width = '0px';
    tocDropdown.style.maxWidth = '0px';
  }

  const getHorizontalPadding = () => {
    if (!dynamicContent) return 0;
    const styles = getComputedStyle(dynamicContent);
    return parseFloat(styles.paddingLeft) + parseFloat(styles.paddingRight);
  };

  const measureCollapsedWidth = () => {
    if (!dynamicContent) return 0;
    const baseWidth = headerRow ? headerRow.getBoundingClientRect().width : dynamicContent.getBoundingClientRect().width;
    return Math.ceil(baseWidth + getHorizontalPadding());
  };

  const measureExpandedWidth = () => {
    if (!dynamicContent || !tocDropdown) return measureCollapsedWidth();

    const prevWidth = tocDropdown.style.width;
    const prevMaxWidth = tocDropdown.style.maxWidth;
    const prevMaxHeight = tocDropdown.style.maxHeight;
    const prevOpacity = tocDropdown.style.opacity;
    const prevTransform = tocDropdown.style.transform;

    tocDropdown.style.width = 'max-content';
    tocDropdown.style.maxWidth = '80vw';
    tocDropdown.style.maxHeight = 'none';
    tocDropdown.style.opacity = '0';
    tocDropdown.style.transform = 'none';

    const dropdownWidth = tocDropdown.scrollWidth;
    const target = Math.max(measureCollapsedWidth(), Math.ceil(dropdownWidth + getHorizontalPadding()));

    tocDropdown.style.width = prevWidth;
    tocDropdown.style.maxWidth = prevMaxWidth;
    tocDropdown.style.maxHeight = prevMaxHeight;
    tocDropdown.style.opacity = prevOpacity;
    tocDropdown.style.transform = prevTransform;

    return target;
  };

  const setDropdownWidth = (opening) => {
    if (!tocDropdown) return;
    if (opening) {
      tocDropdown.style.width = '100%';
      tocDropdown.style.maxWidth = '80vw';
    } else {
      tocDropdown.style.width = '0px';
      tocDropdown.style.maxWidth = '0px';
    }
  };

  const clampTocHeight = () => {
    if (!tocDropdown) return 0;
    const maxViewportHeight = window.innerHeight * 0.6;
    return Math.min(tocDropdown.scrollHeight, maxViewportHeight);
  };

  const animateTocHeight = (opening) => {
    if (!tocDropdown) return;
    const startHeight = tocDropdown.offsetHeight;
    const targetHeight = opening ? clampTocHeight() : 0;
    tocDropdown.style.maxHeight = `${startHeight}px`;
    requestAnimationFrame(() => {
      tocDropdown.style.maxHeight = `${targetHeight}px`;
    });
  };

  const playSpring = (direction) => {
    if (!dynamicContent) return;
    dynamicContent.classList.remove('spring-open', 'spring-close');
    requestAnimationFrame(() => {
      dynamicContent.classList.add(direction === 'open' ? 'spring-open' : 'spring-close');
    });
  };

  const openToc = () => {
    island?.classList.add('open');
    playSpring('open');
    const collapsedWidth = measureCollapsedWidth();
    const targetWidth = measureExpandedWidth();
    setDropdownWidth(true);
    animateTocHeight(true);
    if (dynamicContent) {
      dynamicContent.style.width = `${collapsedWidth}px`;
      requestAnimationFrame(() => {
        dynamicContent.style.width = `${targetWidth}px`;
      });
    }
    tocDropdown?.classList.add('opacity-100', 'scale-y-100');
    tocDropdown?.classList.remove('opacity-0', 'scale-y-95', 'pointer-events-none');
    tocDropdown?.setAttribute('aria-hidden', 'false');
  };
  const closeToc = () => {
    island?.classList.remove('open');
    playSpring('close');
    const startWidth = dynamicContent?.offsetWidth ?? 0;
    const targetWidth = measureCollapsedWidth();
    animateTocHeight(false);
    if (dynamicContent) {
      dynamicContent.style.width = `${startWidth}px`;
      requestAnimationFrame(() => {
        dynamicContent.style.width = `${targetWidth}px`;
        setDropdownWidth(false);
      });
    } else {
      setDropdownWidth(false);
    }
    tocDropdown?.classList.remove('opacity-100', 'scale-y-100');
    tocDropdown?.classList.add('opacity-0', 'scale-y-95', 'pointer-events-none');
    tocDropdown?.setAttribute('aria-hidden', 'true');
  };
  // Toggle TOC
  island?.addEventListener('click', (e) => {
    e.stopPropagation();
    isTocOpen = !isTocOpen;
    
    if (isTocOpen) {
      openToc();
    } else {

      closeToc();
    }
  });

  // Close TOC when clicking outside
  document.addEventListener('click', (e) => {
    if (isTocOpen && !island?.contains(e.target)) {
      isTocOpen = false;
      closeToc();
    }
  });

  // Prevent closing when clicking inside the dropdown links
  tocDropdown?.addEventListener('click', (e) => {
    e.stopPropagation();
  });

  // Scroll & Progress Logic
  function updateProgress() {
    const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
    const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    const scrolled = (winScroll / height) * 100;
    
    
    if (progressCircle) {
      progressCircle.setAttribute('stroke-dasharray', `${scrolled}, 100`);
    }
  }

  let headerObserver = null;

  function initDynamicProgressBar() {
    const container = document.getElementById('dynamic-island-container');
    const header = document.getElementById('blog-header');
    
    if (!container || !header) {
      console.warn('DynamicProgressBar: dynamic-island-container or blog-header not found');
      return;
    }

    if (headerObserver) {
      headerObserver.disconnect();
    }

    headerObserver = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (!entry.isIntersecting) {
            container.classList.remove('opacity-0', 'translate-y-[-20px]', 'pointer-events-none');
            if (isTocOpen) {
              isTocOpen = false;
              closeToc();
            }
          } else {
            container.classList.add('opacity-0', 'translate-y-[-20px]', 'pointer-events-none');
          }
        });
      },
      {
        threshold: 0,
        rootMargin: '0px',
      }
    );

    headerObserver.observe(header);
  }

  window.addEventListener('scroll', updateProgress);
  window.addEventListener('resize', () => {
    updateProgress();
    if (isTocOpen && tocDropdown) {
      tocDropdown.style.maxHeight = `${clampTocHeight()}px`;
      setDropdownWidth(true);
      const targetWidth = measureExpandedWidth();
      if (dynamicContent) {
        dynamicContent.style.width = `${targetWidth}px`;
      }
    }
  });

  updateProgress();

  dynamicContent?.addEventListener('animationend', () => {
    dynamicContent.classList.remove('spring-open', 'spring-close');
  });

  dynamicContent?.addEventListener('transitionend', (e) => {
    if (e.propertyName === 'width' && !isTocOpen) {
      dynamicContent.style.width = '';
    }
  });

  if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', initDynamicProgressBar);
        
			} else {
				initDynamicProgressBar();
			}

  document.addEventListener('astro:after-swap', () => {
    initDynamicProgressBar();
    updateProgress();
  });
</script>

<style>
  #toc-dropdown::-webkit-scrollbar {
    width: 4px;
  }
  #toc-dropdown::-webkit-scrollbar-track {
    background: transparent;
  }
  #toc-dropdown::-webkit-scrollbar-thumb {
    background: rgba(var(--accent), 0.2);
    border-radius: 4px;
  }

  #toc-dropdown {
    width: 0;
    max-width: 0;
    will-change: max-height, opacity, transform, width;
  }

  .dynamic-island-content {
    transform-origin: top center;
    transition: width 260ms cubic-bezier(0.22, 1, 0.36, 1);
  }

  .dynamic-island-content.spring-open {
    animation: spring-open 380ms ease-in-out
  }

  .dynamic-island-content.spring-close {
    animation: spring-close 280ms cubic-bezier(0.33, 1, 0.68, 1);
  }

  @keyframes spring-open {
    45% { transform: scale(1.02, 1.04); }
    85% { transform: scale(0.995, 0.985); }
    100% { transform: scale(1); }
  }

  @keyframes spring-close {
    0% { transform: scale(1.01, 1.01); }
    35% { transform: scale(0.98, 0.94); }
    70% { transform: scale(1.005, 0.99); }
    100% { transform: scale(1); }
  }
</style>
