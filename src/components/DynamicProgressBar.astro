---
import { Icon } from 'astro-icon/components';
import type { MarkdownHeading } from 'astro';

interface Props {
  title: string;
  headings: MarkdownHeading[];
}

const { title, headings } = Astro.props;
---

<div id="dynamic-island-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 transition-all duration-300 opacity-0 translate-y-[-20px] pointer-events-none">
  <div id="dynamic-island" class="relative group cursor-pointer">
    
    <div class="dynamic-island-content relative flex flex-col items-center px-4 py-2 bg-background/60 backdrop-blur-md border border-white/10 rounded-xl shadow-lg">
      <div class="flex items-center gap-3">
       <div class="relative w-5 h-5 flex items-center justify-center">
          <svg class="w-full h-full -rotate-90" viewBox="0 0 36 36">
          <path
            class="text-muted/20"
            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
            fill="none"
            stroke="currentColor"
            stroke-width="4"
          />
          <path
            id="progress-circle"
            class="text-accent transition-all duration-100 ease-out"
            stroke-dasharray="0, 100"
            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
            fill="none"
            stroke="currentColor"
            stroke-width="4"
          />
        </svg>
      </div>
      <span class="text-sm font-medium truncate max-w-[200px] sm:max-w-[300px]">{title}</span>
      <Icon name="lucide:chevron-down" class="w-4 h-4 text-muted-foreground transition-transform duration-300 group-[.open]:rotate-180" />
       </div>

    <!-- Table of Contents Dropdown -->
    <div
      id="toc-dropdown"
      class="w-full max-h-0 opacity-0 scale-y-95 pointer-events-none overflow-hidden origin-top transition-[max-height,opacity,transform] duration-[400ms] ease-[cubic-bezier(0.22,1,0.36,1)]"
      aria-hidden="true"
    >
      <nav class="flex flex-col gap-1">
        {headings.filter(h => h.depth <= 3).map((heading) => (
          <a 
            href={`#${heading.slug}`} 
            class:list={[
              "text-sm px-3 py-1.5 rounded-lg hover:bg-accent/10 transition-colors text-muted-foreground hover:text-foreground truncate block",
              { "pl-3": heading.depth === 1, "pl-6": heading.depth === 2, "pl-9": heading.depth === 3 }
            ]}
          >
            {heading.text}
          </a>
        ))}
      </nav>
    </div>
    </div>


  </div>
</div>

<script is:inline data-astro-rerun>
  const island = document.getElementById('dynamic-island');
  const progressCircle = document.getElementById('progress-circle');
  const tocDropdown = document.getElementById('toc-dropdown');
  const dynamicContent = document.querySelector('.dynamic-island-content');

  let isTocOpen = false;

  if (tocDropdown) {
    tocDropdown.style.maxHeight = '0px';
  }

  const clampTocHeight = () => {
    if (!tocDropdown) return 0;
    const maxViewportHeight = window.innerHeight * 0.6;
    return Math.min(tocDropdown.scrollHeight, maxViewportHeight);
  };

  const animateTocHeight = (opening) => {
    if (!tocDropdown) return;
    const startHeight = tocDropdown.offsetHeight;
    const targetHeight = opening ? clampTocHeight() : 0;
    tocDropdown.style.maxHeight = `${startHeight}px`;
    requestAnimationFrame(() => {
      tocDropdown.style.maxHeight = `${targetHeight}px`;
    });
  };

  const playSpring = (direction) => {
    if (!dynamicContent) return;
    dynamicContent.classList.remove('spring-open', 'spring-close');
    requestAnimationFrame(() => {
      dynamicContent.classList.add(direction === 'open' ? 'spring-open' : 'spring-close');
    });
  };

  const openToc = () => {
    island?.classList.add('open');
    playSpring('open');
    animateTocHeight(true);
    tocDropdown?.classList.add('opacity-100', 'scale-y-100');
    tocDropdown?.classList.remove('opacity-0', 'scale-y-95', 'pointer-events-none');
    tocDropdown?.setAttribute('aria-hidden', 'false');
  };
  const closeToc = () => {
    island?.classList.remove('open');
    playSpring('close');
    animateTocHeight(false);
    tocDropdown?.classList.remove('opacity-100', 'scale-y-100');
    tocDropdown?.classList.add('opacity-0', 'scale-y-95', 'pointer-events-none');
    tocDropdown?.setAttribute('aria-hidden', 'true');
  };
  // Toggle TOC
  island?.addEventListener('click', (e) => {
    e.stopPropagation();
    isTocOpen = !isTocOpen;
    
    if (isTocOpen) {
      openToc();
    } else {
      closeToc();
    }
  });

  // Close TOC when clicking outside
  document.addEventListener('click', (e) => {
    if (isTocOpen && !island?.contains(e.target)) {
      isTocOpen = false;
      closeToc();
    }
  });

  // Scroll & Progress Logic
  function updateProgress() {
    const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
    const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    const scrolled = (winScroll / height) * 100;
    
    
    if (progressCircle) {
      progressCircle.setAttribute('stroke-dasharray', `${scrolled}, 100`);
    }
  }

  function initDynamicProgressBar() {
			const container = document.getElementById('dynamic-island-container');
			const header = document.getElementById('blog-header');
			
			if (!container || !header) {
				console.warn('DynamicProgressBar: dynamic-island-container or blog-header not found');
				return;
			}

			const observer = new IntersectionObserver(
				(entries) => {
					entries.forEach((entry) => {
						if (!entry.isIntersecting) {
							container.classList.remove('opacity-0', 'translate-y-[-20px]', 'pointer-events-none');
              if (isTocOpen) {
                  isTocOpen = false;
                  closeToc();
                }
						} else {
              container.classList.add('opacity-0', 'translate-y-[-20px]', 'pointer-events-none');
						}
					});
				},
				{
					threshold: 0,
					rootMargin: '0px',
				}
			);

			observer.observe(header);
		}

  window.addEventListener('scroll', updateProgress);
  window.addEventListener('resize', () => {
    updateProgress();
    if (isTocOpen && tocDropdown) {
      tocDropdown.style.maxHeight = `${clampTocHeight()}px`;
    }
  });

  updateProgress();

  dynamicContent?.addEventListener('animationend', () => {
    dynamicContent.classList.remove('spring-open', 'spring-close');
  });

  if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', initDynamicProgressBar);
		} else {
			initDynamicProgressBar();
		}
</script>

<style>
  #toc-dropdown::-webkit-scrollbar {
    width: 4px;
  }
  #toc-dropdown::-webkit-scrollbar-track {
    background: transparent;
  }
  #toc-dropdown::-webkit-scrollbar-thumb {
    background: rgba(var(--accent), 0.2);
    border-radius: 4px;
  }

  #toc-dropdown {
    will-change: max-height, opacity, transform;
  }

  .dynamic-island-content {
    transform-origin: top center;
  }

  .dynamic-island-content.spring-open {
    animation: spring-open 380ms cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .dynamic-island-content.spring-close {
    animation: spring-close 280ms cubic-bezier(0.33, 1, 0.68, 1);
  }

  @keyframes spring-open {
    0% { transform: scale(0.98, 0.94); }
    45% { transform: scale(1.02, 1.04); }
    75% { transform: scale(0.995, 0.985); }
    100% { transform: scale(1); }
  }

  @keyframes spring-close {
    0% { transform: scale(1.01, 1.01); }
    35% { transform: scale(0.98, 0.94); }
    70% { transform: scale(1.005, 0.99); }
    100% { transform: scale(1); }
  }
</style>
